<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choose Exam</title>
</head>
<link rel="stylesheet" href='index.css'/>

<button id="back" style="float: left">Back to Main Screen</button><br><br><br><br><br>
<body id="body">
    <select id="exam">
        <option value="empty" selected="selected">Choose Exam</option>
    </select>
    
    <br><br><br>
    <button id="submit" type="button">Submit</button>
    
    <script src="auth.js"></script>
    <script src="filter.js"></script>
    <script>
        checkauth(1);

        var profname = getusername();
        var examchoice = document.getElementById('exam');

        var back = document.getElementById('back');
        back.addEventListener('click', function(){
            window.location.href = "profmain.html";
        });

        var finalJSON = {
            "action": "chooseexamtograde",
            "contents": {
                "username": profname
            }
        };

        var xhttp2 = new XMLHttpRequest();
        xhttp2.onreadystatechange = function() {
            if (this.readyState == 4){

                var msgs = JSON.parse(this.responseText).message;

                for (var i=1; i <= msgs.count; i++){
                    var test = "notsetyet";
                    if (msgs[i]['t_num'] == "0"){
                        test = "Midterm 1";
                    } else if (msgs[i]['t_num'] == "1"){
                        test = "Midterm 2";
                    } else if (msgs[i]['t_num'] == "2"){
                        test = "Final Exam";
                    }
                    examchoice.innerHTML += "<option value=\"" + msgs[i]['t_num'] + "\">" + test + "</option>";
                }
            }
        };
        xhttp2.open("POST", "relay.php", true);
        xhttp2.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        xhttp2.send("req="+JSON.stringify(finalJSON));

        var submit = document.getElementById('submit');
        submit.addEventListener('click', function() {
            var finalJSON = {
                "action": "getstudents",
                "contents": {
                    "username": profname,
                    "t_num": document.getElementById('exam').value
                }
            };

            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4){
                    gradeandsubmitexams(this.responseText, document.getElementById('exam').value);
                }
            };
            xhttp.open("POST", "relay.php", true);
            xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            xhttp.send("req="+JSON.stringify(finalJSON));
        });

        function gradeandsubmitexams(data, examnum){

            var body = document.getElementById('body');

            body.innerHTML = "";
            body.innerHTML += "<button id=\"back\" style=\"float: left\">Back to Main Screen</button><br><br><br><br><br>";
            body.innerHTML += "<select id=\"student\"><option value=\"empty\" selected=\"selected\">Choose Student</option></select>";
            var studentchoice = document.getElementById('student');

            document.getElementById('back').addEventListener('click', function(){
                window.location.href = "profmain.html";
            });

            var msgs = JSON.parse(data).message;

            for (var i=1; i <= msgs.count; i++){
                studentchoice.innerHTML += "<option value=\"" + msgs[i] + "\">" + msgs[i] + "</option>";
            }

            studentchoice.addEventListener('change', function(){

                var qtest = document.getElementById('questions');
                var btest = document.getElementById('submitbutton');
                var stest = document.getElementById('iscoretext');
                var ttest = document.getElementById('totscoretext');
                var otest = document.getElementById('outoftext');

                if (typeof(qtest) != 'undefined' && qtest != null){
                    document.getElementById('questions').remove();
                };
                if (typeof(btest) != 'undefined' && btest != null){
                    document.getElementById('submitbutton').remove();
                };
                if (typeof(stest) != 'undefined' && stest != null){
                    document.getElementById('iscoretext').remove();
                };
                if (typeof(ttest) != 'undefined' && ttest != null){
                    document.getElementById('totscoretext').remove();
                };
                if (typeof(otest) != 'undefined' && otest != null){
                    document.getElementById('outoftext').remove();
                };

                var finalJSON = {
                    "action": "getgradedexam",
                    "contents": {
                        "username": studentchoice.value,
                        "t_num": examnum
                    }
                };

                var xhttp3 = new XMLHttpRequest();
                xhttp3.onreadystatechange = function() {
                    if (this.readyState == 4){
                        var json = JSON.parse(this.responseText);
                        console.log(json)
                        console.log(json['message']['student_data']['question_v'].replace(/\n/g, "\\n").replace(/\t/g, "\\t"))
                        var questions = JSON.parse(json['message']['student_data']['question_v'].replace(/\n/g, "\\n").replace(/\t/g, "\\t"));
                        var question_c = json['message']['student_data']['question_c'];

                        var table = document.createElement('table');
                        table.id = 'questions';
                        table.style = 'width: 80%';
                        for (var i=1; i <= question_c; i++){
                            var tr = table.insertRow();
                            var td = tr.insertCell();
                            td.innerHTML += "<h1>Question " + i + "</h1>";
                            td.innerHTML += "<h3>" + escapeHtmlReverse(json['message'][i]['question']) + "</h3><br>";
                            td.innerHTML += "<textarea readonly type=\"text\" style=\"max-width: 80%; width: 80%\">" + decodeURIComponent(escapeHtmlReverse(questions[i]['answer']).replace(/\+/g, " ")) + "</textarea>";
                            td.innerHTML += "<br><input id=\"qscore\" style=\"width: 3em\" value=\"" + questions[i]['score'] + "\"> out of " + questions[i]['max'];
                            td.innerHTML += "<br><br>Comments: ";
                            td.innerHTML += "<br><textarea type=\"text\" style=\"max-width: 80%\">" + decodeURIComponent(escapeHtmlReverse(questions[i]['comment']).replace(/\+/g, " ")) + "</textarea><br><br>";
                        }
                        body.appendChild(table);

                        var totalscore = document.createElement('div');
                        totalscore.id = "iscoretext";
                        totalscore.style = "font-size: 2em";
                        totalscore.innerHTML = json['message']['student_data']['score'];

                        var totscoretext = document.createElement('div');
                        totscoretext.id = "totscoretext";
                        totscoretext.innerHTML = "Total Score: ";

                        var outoftext = document.createElement('div');
                        outoftext.id = "outoftext";
                        outoftext.innerHTML = " out of " + json['message']['student_data']['max'];

                        body.appendChild(totscoretext);
                        body.appendChild(totalscore);
                        body.appendChild(outoftext);

                        var submitbutton = document.createElement('BUTTON');
                        submitbutton.id = "submitbutton";
                        submitbutton.innerHTML = "Submit";

                        body.appendChild(submitbutton);
                        
                        var qscores = document.getElementsByTagName('input');
                        for (var i=0; i < qscores.length; i++){
                            qscores[i].oninput = function() {
                                var total = 0;
                                for (var i=0, row; row = document.getElementById('questions').rows[i]; i++){
                                    val = row.cells[0].childNodes[5].value;
                                    total += parseInt(val);
                                }
                                document.getElementById('iscoretext').innerHTML = total;
                            };
                        }

                        submitbutton.addEventListener('click', function(){

                            var studentData = json['message']['student_data'];

                            var qs = {};
                            for (var i=0, row; row = table.rows[i]; i++){
                                var q_num = json['message'][i+1]['q_num'];
                                var answer = decodeURIComponent(questions[i+1]['answer'].replace(/\+/g, " "));
                                var comment = row.cells[0].childNodes[11].value;
                                var iscore = row.cells[0].childNodes[5].value;
                                var max = questions[i+1]['max'];
                                qs[i+1] = {"q_num": q_num, "answer": answer,  "comment": comment,  "score": iscore,  "max": max};
                            }

                            var finalJSON = {
                                "action": "finishedexam",
                                "contents": {
                                    "student": studentData['student'],
                                    "t_num": studentData['t_num'],
                                    "q_count": studentData['question_c'],
                                    "questions": qs,
                                    "score": totalscore.innerHTML,
                                    "max": studentData['max']
                                }
                            };

                            var xhttp = new XMLHttpRequest();
                            xhttp.onreadystatechange = function() {
                                if (this.readyState == 4){
                                    var msg = JSON.parse(this.responseText).message;
                                    var content = document.createElement("DIV");
                                    content.style.fontSize = "large";
                                    content.innerHTML = msg;
                                    content.id = "alert";
                                    document.getElementById('body').appendChild(content);
                                    window.scrollTo(0, document.body.scrollHeight);
                                    setTimeout(function(){
                                        var elem = document.getElementById('alert');
                                        elem.parentNode.removeChild(elem);
                                    }, 2000);
                                }
                            };
                            xhttp.open("POST", "relay.php", true);
                            xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                            xhttp.send("req="+encodeURIComponent(JSON.stringify(finalJSON)));
                        });

                    }
                };
                xhttp3.open("POST", "relay.php", true);
                xhttp3.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhttp3.send("req="+encodeURIComponent(JSON.stringify(finalJSON)));
            });
        }
    </script>
</body>
</html>